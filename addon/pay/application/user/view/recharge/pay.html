{extend name='common/default'/}
{block name="main"}
<div class="row">
    <div class="col-md-12">
        <div class="block block-themed block-rounded block-shadow">
            <div class="block-header block-header-default bg-gd-sea">
                <h3 class="block-title">{$title}</h3>
                <div class="block-options">
                    <button type="button" class="btn-block-option">
                        <i class="si si-wrench"></i>
                    </button>
                </div>
            </div>
            <div class="block-content">
                <div class="alert alert-warning bg-gd-emerald" role="alert" style="color:white;text-align:center;">
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button>
                    <strong>尊敬的用户:{:qqname($uinfo.qq)}</strong> 请使用微信扫码完成支付！
                </div>
                <center style="padding-bottom: 30px;">
                    <div class="qr-image" id="qrcode"></div><br/>
                    {if $m==1}<a href="weixin://" class="btn btn-success btn-sm">打开微信</a>{/if}
                </center>
            </div>
        </div>
    </div>
</div>
{/block}
{block name="footjs"}
<script src="/static/js/qrcode.min.js"></script>
<script>
    var qrcode = new QRCode("qrcode", {
        text: "{$code_url | raw}",
        width: 230,
        height: 230,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
    });

    function loadmsg() {
        var trade_no = '{$trade_no}';
        $.ajax({
            type: "GET",
            dataType: "json",
            url: "getshop.html?trade_no="+trade_no,
            timeout: 10000,
            success: function (data, textStatus) {
                if (data.code == 1) {
                    layer.msg('支付成功，正在跳转中...', {icon: 16,shade: 0.01,time: 15000});
                    window.location.href='{:url('/user/recharge')}';
                }else{
                    setTimeout("loadmsg()", 4000);
                }
            },
            //Ajax请求超时，继续查询
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                if (textStatus == "timeout") {
                    setTimeout("loadmsg()", 1000);
                } else { //异常
                    setTimeout("loadmsg()", 4000);
                }
            }
        });
    }
    window.onload = loadmsg();
</script>
{/block}
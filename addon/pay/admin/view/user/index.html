{extend name="/common/default" /}
{block name="main"}
<style>
    .pages {
        margin-top: 20px;
        float: left;
    }

    .pages a, .pages span {
        display: inline-block;
        padding: 2px 10px;
        border: 1px solid #f0f0f0;
        -webkit-border-radius: 3px;
        -moz-border-radius: 3px;
        border-radius: 3px;
        font-size: 14px;
    }

    .pages a, .pages li {

        display: inline-block;
        list-style: none;
        text-decoration: none;
        color: #58A0D3;
    }

    .pages a.first, .pages a.prev, .pages a.next, .pages a.end {
        margin: 0 auto;
    }

    .pages a:hover {
        border-color: #50A8E6;
    }

    .pages span.current {
        background: #50A8E6;
        color: #FFF;
        font-weight: 700;
        border-color: #50A8E6;
    }

    .table-responsive {
        min-height: .01%;
        overflow-x: auto;
    }

    @media screen {
        .table-responsive {
            width: 100%;
            margin-bottom: 15px;
            overflow-y: hidden;
            -ms-overflow-style: -ms-autohiding-scrollbar;
            border: 1px solid #ddd;
        }

        .table-responsive > .table {
            margin-bottom: 0;
        }

        .table-responsive > .table > thead > tr > th,
        .table-responsive > .table > tbody > tr > th,
        .table-responsive > .table > tfoot > tr > th,
        .table-responsive > .table > thead > tr > td,
        .table-responsive > .table > tbody > tr > td,
        .table-responsive > .table > tfoot > tr > td {
            white-space: nowrap;
        }

        .table-responsive > .table-bordered {
            border: 0;
        }

        .table-responsive > .table-bordered > thead > tr > th:first-child,
        .table-responsive > .table-bordered > tbody > tr > th:first-child,
        .table-responsive > .table-bordered > tfoot > tr > th:first-child,
        .table-responsive > .table-bordered > thead > tr > td:first-child,
        .table-responsive > .table-bordered > tbody > tr > td:first-child,
        .table-responsive > .table-bordered > tfoot > tr > td:first-child {
            border-left: 0;
        }

        .table-responsive > .table-bordered > thead > tr > th:last-child,
        .table-responsive > .table-bordered > tbody > tr > th:last-child,
        .table-responsive > .table-bordered > tfoot > tr > th:last-child,
        .table-responsive > .table-bordered > thead > tr > td:last-child,
        .table-responsive > .table-bordered > tbody > tr > td:last-child,
        .table-responsive > .table-bordered > tfoot > tr > td:last-child {
            border-right: 0;
        }

        .table-responsive > .table-bordered > tbody > tr:last-child > th,
        .table-responsive > .table-bordered > tfoot > tr:last-child > th,
        .table-responsive > .table-bordered > tbody > tr:last-child > td,
        .table-responsive > .table-bordered > tfoot > tr:last-child > td {
            border-bottom: 0;
        }
    }
</style>
<div class="block">
    <div class="block-header block-header-default bg-info">
        <h3 class="block-title">{$title}</h3>
    </div>
    <div class="block-content">
        <form action="/{:ADMIN_DIR}/user/index">
            <div class="form-group row">
                <div class="col-lg-4">
                    <div class="input-group">
                        <input type="text" class="form-control" id="example-input1-group2" name="search"
                               placeholder="可通过UID,用户名,QQ,邮箱查找">
                        <div class="input-group-prepend">
                            <button type="submit" class="btn btn-info">
                                <i class="fa fa-search"></i> 查找
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        <div class="table-responsive">
            <table class="table table-bordered table-vcenter">
                <thead>
                <tr>
                    <th class="text-center">uid</th>
                    <th>用户名</th>
                    <th>用户邮箱</th>
                    <th>用户QQ</th>
                    <th>用户注册时间</th>
                    <th>会员等级</th>
                    <th>用户余额</th>
                    <th>微信费率</th>
                    <th>VIP到期时间</th>
                    <th>用户状态</th>
                    <th class="text-center">操作</th>
                </tr>
                </thead>
                <tbody>
                {foreach $user as $k=>$v}
                <tr>
                    <td class="text-center">{$v['uid']}</td>
                    <td class="font-w600">{$v['uname']}</td>
                    <td>{$v['email']}</td>
                    <td>{$v['qq']}</td>
                    <td>{$v['created_at']}</td>
                    <td>{$v['vname']}</td>
                    <td>{$v['uprice']}元</td>
                    <td>{if $v['wx_rate']}{if $v['v_time_expire']<date('Y-m-d')}{:config('wx_default_rate')}{else}{$v['wx_rate']}{/if}{else /}{:config('wx_rate')}{/if}%</td>
                    <td>{$v['v_time_expire']}</td>
                    <td id="seal-{$v['uid']}">
                        {if $v['status']==1}
                        <button class="btn btn-sm badge-success" onclick="seal(0,{$v['uid']})">激活</button>
                        {else/}
                        <button class="btn btn-sm badge-danger" onclick="seal(1,{$v['uid']})">封禁</button>
                        {/if}
                    </td>
                    <td class="text-center">
                        <div class="btn-group">
                            <a class="btn btn-sm btn-secondary js-tooltip-enabled"
                               href="/{:ADMIN_DIR}/user/edit/{$v['uid']}?token={$v['token']}" title="修改信息">
                                <i class="fa fa-pencil"></i>
                            </a>

                            <input type="hidden" id="{$v['uid']}" value="{$v['token']}">
                            <button type="button" onclick="del({$v['uid']},this)"
                                    class="btn btn-sm btn-secondary js-tooltip-enabled">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {/foreach}
                </tbody>
            </table>
        </div>
    </div>
</div>
{/block}
{block name="footjs"}
<script>
    function seal(id, uid) {
        layer.confirm('是否确认更改用户状态？', {
                btn: ['确认', '取消'] //按钮
            }, function () {
                let to = $('#' + uid).val();
                layer.load(2, {shade: [0.1, '#fff']});
                $.ajax({
                    url: "/{:ADMIN_DIR}/user/seal",
                    type: 'post',
                    dataType: 'json',
                    data: {id: id, utoken: to, uid: uid},
                    success: function (res) {
                        layer.closeAll();
                        if (res.code == 1) {
                            layer.alert(res.msg, {icon: 6});
                            if (res.msg == '封禁成功') {
                                $('#seal-'+uid).html(`<button class="btn btn-sm badge-danger" onclick="seal(1,${uid})">封禁</button>`);
                            } else {
                                $('#seal-'+uid).html(`<button class="btn btn-sm badge-success" onclick="seal(0,${uid})">激活</button>`);
                            }
                        } else {
                            layer.msg(res, {icon: 5});
                        }
                    },
                    timeout: 10000,
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        layer.closeAll();
                        if (textStatus == "timeout") {
                            layer.msg('请求超时！');
                        } else {
                            layer.msg('服务器错误！');
                        }
                    }
                });
            }
        )
    }
</script>
<script>
    function del(id, obj) {
        layer.confirm('是否确认删除？', {
                btn: ['确认', '取消'] //按钮
            }, function () {
                let to = $('#' + id).val();
                layer.load(2, {shade: [0.1, '#fff']});
                $.ajax({
                    url: "/{:ADMIN_DIR}/user/del",
                    type: 'post',
                    dataType: 'json',
                    data: {uid: id, utoken: to},
                    success: function (res) {
                        layer.closeAll();
                        if (res == '删除成功') {
                            layer.alert(res, {icon: 6});
                            $(obj).parent().parent().parent().remove();
                        } else {
                            layer.msg(res, {icon: 5});
                        }
                    },
                    timeout: 10000,
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        layer.closeAll();
                        if (textStatus == "timeout") {
                            layer.msg('请求超时！');
                        } else {
                            layer.msg('服务器错误！');
                        }
                    }
                });
            }
        )
    }

</script>
{/block}
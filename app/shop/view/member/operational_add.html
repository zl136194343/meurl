{extend name="base"/}
{block name="resources"}
<style>
	.ns-form {margin-top: 0;}
</style>
{/block}
{block name="main"}
<div class="layui-form ns-form">
<div class="ns-pay-win">
					<div class="layui-form-item">
				<label class="layui-form-label type_3_settlement_bank_account_name"><span class="required">*</span>微信绑定：</label>
				<div class="layui-input-block ns-check-member">
					<input type="text" id="search_text" name="search_text" placeholder="请输入会员名或手机" class="layui-input ns-len-mid ns-member-name">
					<button type="button" class="layui-btn layui-btn-primary" onclick="checkMember()">
						<i class="layui-icon"></i>
					</button>
					<input class="ns-member-id" type="hidden" name="member_id">
				</div>
			</div>

			<div class="layui-form-item">
				<label class="layui-form-label ns-pay-alipay-name">用户真实姓名：</label>
				<div class="layui-input-inline">
										<input name="weixin_settlement_bank_account_name" type="text" id="weixin_settlement_bank_account_name" value="" class="layui-input ns-len-long" autocomplete="off">
									</div>
			</div>

			<div class="layui-form-item">
				<label class="layui-form-label">微信昵称：</label>
				<div class="layui-input-inline">
										<input name="weixin_settlement_bank_address" id="weixin_settlement_bank_address" type="text" value="" disabled="" class="layui-input ns-dis-input ns-len-long" autocomplete="off" lay-verify="required">
									</div>
			</div>

			<div class="layui-form-item">
				<label class="layui-form-label">微信账号：</label>
				<div class="layui-input-inline">
										<input name="weixin_settlement_bank_name" id="weixin_settlement_bank_name" type="text" value="" class="layui-input ns-len-long" autocomplete="off" lay-verify="required">
									</div>
			</div>

			<!-- 微信openid -->
						<input name="member_id" value="" type="hidden" class="layui-input">
					</div>
    	 <!--<div class="layui-form-item">
    		<label class="layui-form-label">是否使用：</label>
    		<div class="layui-input-block">
    			<input type="checkbox" name="is_type" value="1" lay-skin="switch" checked />
    		</div>
    	</div> -->

	<div class="ns-form-row">
		<button class="layui-btn ns-bg-color" lay-submit lay-filter="save">保存</button>
		<button class="layui-btn layui-btn-primary" onclick="back()">返回</button>
	</div>
</div>
{/block}
{block name="script"}
<script>
	layui.use('form', function() {
		var form = layui.form,
			repeat_flag = false; //防重复标识
		form.render();

		/**
		 * 监听保存
		 */
		form.on('submit(save)', function(data) {
			if (repeat_flag) return false;
			repeat_flag = true;
			$.ajax({
				url: ns.url("shop/member/operationalAdd"),
				data: data.field,
				dataType: 'JSON', //服务器返回json格式数据
				type: 'POST', //HTTP请求类型
				success: function(res) {
					repeat_flag = false;
					if (res.code == 0) {
						layer.confirm('添加成功', {
							title:'操作提示',
							btn: ['返回列表', '继续添加'],
							yes: function(){
								location.href = ns.url("shop/member/operational")
							},
							btn2: function() {
								location.href = ns.url("shop/member/operationalAdd")
							}
						});
					}else{
						layer.msg(res.message);
					}
				}
			});
		});
		/**
		 * 表单验证
		 */
	
	});
 	function back(){
		location.href = ns.url("shop/member/operational");
	}
	var repeat_flag_member = false;
	var html, val
	function checkMember() {
		var parent = $(".ns-check-member");
		var con = parent.find(".ns-member-name").val();
		$(".layui-word-aux").remove();
		$(".ns-search-result").remove();

		if (repeat_flag_member) return false;
		repeat_flag_member = true;

		if (con == "" || con == null || con.trim() == "") {
			repeat_flag = false;
		} else {
			$.ajax({
				type: 'POST',
				url: ns.url("shop/verify/searchMember"),
				data: {
					'search_text': con
				},
				dataType: 'JSON',
				success: function(res) {
					// layer.msg(res.message);
					repeat_flag_member = false;

					if (res.data == null) {
						html = '<span class="layui-word-aux">未找到该用户</span>';
						val = res.data;
					} else {
						html = '<div class="ns-search-result layui-input-inline ns-border-color-gray">' +
								'<div class="ns-search-res-img">' +
								'<img src="' + ns.img(res.data.headimg) + '" onerror="javascript:this.src=\'https://xyhl.chnssl.com/app/admin/view/public/img/default_headimg.png\';"/>' +
								'</div>' +
								'<div class="ns-search-res-intro">' +
								'<p>用户名：' + res.data.realname + '</p>' +
								'<p>电话：' + res.data.mobile + '</p>' +
								'</div>' +
								'<div class="ns-search-res-close" onclick="closeMember()">' +
								'<i class="iconfont iconclose_light"></i>' +
								'</div>' +
								'</div>';
						val = res.data.member_id;
					}

					$(".ns-member-id").attr("value", val);
					$("#weixin_settlement_bank_account_name").val(res.data.realname);
					$("#weixin_settlement_bank_address").val(res.data.nickname);
					$("#weixin_settlement_bank_name").val(res.data.mobile);
					$("input[name='member_id']").val(res.data.member_id);

					$(".ns-check-member").append(html);
				}
			});
		}
	}
</script>
{/block}
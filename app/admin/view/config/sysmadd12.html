<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%
	String path = request.getContextPath();
	String basePath = request.getScheme()+"://"+request.getServerName()+":"+request.getServerPort()+path+"/";
%>
<!DOCTYPE html>
<html lang="en">
	<head>
	<base href="<%=basePath%>">
	<!-- 下拉框 -->
	<link rel="stylesheet" href="static/ace/css/chosen.css" />
	<!-- jsp文件头和头部 -->
	<%@ include file="../../system/index/top.jsp"%>
	<!-- 日期框 -->
	<link rel="stylesheet" href="static/ace/css/datepicker.css" />
	<link rel="stylesheet" href="static/layui/css/layui.css" />
	<style type="text/css">
		.layui-upload-list {
			position: relative;
			display: flex;
			flex-wrap: wrap;
		}
		.layui-upload-list div{
			position: relative;
		}
		.layui-upload-list div .delete{
			position: absolute;
			top: 0px;
			right: 10px;
			width: 20px;
			height: 20px;
			border-radius: 100%;
			background-color: #FFF;
			color: red;
			font-weight: bold;
		}
		.layui-upload-img {
			width: 92px;
			height: 92px;
			margin: 0px 10px 0px 10px;
		}
		.layui-upload-audio {
			width: 300px;
			height: 50px;
			margin: 0px 10px 0px 10px;
		}
		.layui-upload-video {
			width: 300px;
			height: auto;
			margin: 0px 10px 0px 10px;
		}
	</style>
	</head>
<body class="no-skin">
<!-- /section:basics/navbar.layout -->
<div class="main-container" id="main-container">
	<!-- /section:basics/sidebar -->
	<div class="main-content">
		<div class="main-content-inner">
			<div class="page-content">
				<div class="row">
					<div class="col-xs-12">
					
					<form action="info/${msg }.do" name="Form" id="Form" method="post">
						<input type="hidden" name="INFO_ID" id="INFO_ID" value="${pd.INFO_ID}"/>
						<div id="zhongxin" style="padding-top: 13px;">
 
						<table id="table_report" class="table table-striped table-bordered table-hover">
							<tr>
								<td style="width:75px;text-align: right;padding-top: 13px;">图片:</td>
								<td>
									<div class="layui-upload">
										<button type="button" class="layui-btn" id="uploadPics">上传图片</button><span style="color:red">&nbsp;&nbsp;&nbsp;*仅上传图片格式：jpg,jpeg,png,bmp,gif</span>
										<div class="layui-upload-list" id="demo1"></div>
									</div>
									<input type="hidden" name="PICTURES" id="PICTURES" value="${pd.PICTURES}" style="width:98%;margin-top: 10px"/>
									<input type="hidden" name="THUMBNAILS" id="THUMBNAILS" value="${pd.THUMBNAILS}"  style="width:98%;"/>
								</td>
							</tr>
							<tr>
								<td style="width:75px;text-align: right;padding-top: 13px;">音频:</td>
								<td>
									<div class="layui-upload">
										<button type="button" class="layui-btn" id="uploadAudios">上传音频</button><span style="color:red">&nbsp;&nbsp;&nbsp;*仅上传音频格式：wav,mp3,ogg,webm</span>
										<div class="layui-upload-list" id="demo2"></div>
									</div>
									<input type="hidden" name="AUDIOS" id="AUDIOS" value="${pd.AUDIOS}" style="width:98%;margin-top: 10px"/>
								</td>
							</tr>
							<tr>
								<td style="width:75px;text-align: right;padding-top: 13px;">视频:</td>
								<td>
									<div class="layui-upload">
										<button type="button" class="layui-btn" id="uploadVideos">上传视频</button><span style="color:red">&nbsp;&nbsp;&nbsp;*仅上传视频格式：mp4,webm,ogg</span>
										<div class="layui-upload-list" id="demo3"></div>
									</div>
									<input type="hidden" name="VIDEOS" id="VIDEOS" value="${pd.VIDEOS}" style="width:98%;margin-top: 10px"/>
								</td>
							</tr>
							<tr>
								<td colspan="2">
									<input type="hidden" name="APPENDIXS" id="APPENDIXS" value="${pd.APPENDIXS}" style="width:98%;margin-top: 10px"/>
									<div class="layui-upload" style="margin-bottom:25px">
			                          <button type="button" class="layui-btn" id="uploadFiles">上传文件</button><span style="color:red">&nbsp;&nbsp;&nbsp;*仅上传文件格式：pdf</span>
			                          <div class="layui-upload-list">
			                            <table class="layui-table">
			                              <thead>
			                                <tr>
				                                <th>文件名</th>
				                                <th>状态</th>
				                                <th style="width:240px">操作</th>
			                              	</tr>
			                              </thead>
			                              <tbody id="demo4">
			                              </tbody>
			                            </table>
			                          </div>
			                        </div>
								</td>
							</tr>
							<tr>
								<td style="text-align: center;" colspan="10">
									<a class="btn btn-mini btn-primary" onclick="save();">保存</a>
									<a class="btn btn-mini btn-danger" onclick="top.Dialog.close();">取消</a>
								</td>
							</tr>
						</table>
						</div>
						<div id="zhongxin2" class="center" style="display:none"><br/><br/><br/><br/><br/><img src="static/images/jiazai.gif" /><br/><h4 class="lighter block green">提交中...</h4></div>
					</form>
					</div>
					<!-- /.col -->
				</div>
				<!-- /.row -->
			</div>
			<!-- /.page-content -->
		</div>
	</div>
	<!-- /.main-content -->
</div>
<!-- /.main-container -->
 
 
	<!-- 页面底部js¨ -->
	<%@ include file="../../system/index/foot.jsp"%>
	<!-- 删除时确认窗口 -->
	<script src="static/ace/js/bootbox.js"></script>
	<!-- 下拉框 -->
	<script src="static/ace/js/chosen.jquery.js"></script>
	<!-- 日期框 -->
	<script src="static/ace/js/date-time/bootstrap-datepicker.js"></script>
	<!--提示框-->
	<script type="text/javascript" src="static/js/jquery.tips.js"></script>
	<script type="text/javascript" src="static/layui/layui.all.js" charset="utf-8"></script>
	<!-- 百度编辑器 -->
	<script type="text/javascript" charset="utf-8">window.UEDITOR_HOME_URL = "<%=path%>/plugins/ueditor/";</script>
	<script type="text/javascript" src="plugins/ueditor/ueditor.config.js" charset="utf-8"></script>
	<script type="text/javascript" src="plugins/ueditor/ueditor.all.js" charset="utf-8"></script>
		<script type="text/javascript">
		$(top.hangge());
		//保存
		function save(){
			
			var pictures = "";
            for ( var i = 0; i < picturePaths.length; i++) {
				if (i == 0) {
                    pictures = picturePaths[i];
				} else {
                    pictures = pictures + "," + picturePaths[i];
                }
			}
			$("#PICTURES").val(pictures);
 
            var thumbnails = "";
            for ( var i = 0; i < thumbnailPaths.length; i++) {
                if (i == 0) {
                    thumbnails = thumbnailPaths[i];
                } else {
                    thumbnails = thumbnails + "," + thumbnailPaths[i];
                }
            }
            $("#THUMBNAILS").val(thumbnails);
 
            var audios = "";
            for ( var i = 0; i < audioPaths.length; i++) {
                if (i == 0) {
                    audios = audioPaths[i];
                } else {
                    audios = audios + "," + audioPaths[i];
                }
            }
            $("#AUDIOS").val(audios);
 
            var videos = "";
            for ( var i = 0; i < videoPaths.length; i++) {
                if (i == 0) {
                    videos = videoPaths[i];
                } else {
                    videos = videos + "," + videoPaths[i];
                }
            }
            $("#VIDEOS").val(videos);
 
            var appendixs = "";
            for ( var i = 0; i < appendixPaths.length; i++) {
                if (i == 0) {
                    appendixs = appendixPaths[i];
                } else {
                    appendixs = appendixs + "," + appendixPaths[i];
                }
            }
            $("#APPENDIXS").val(appendixs);
 
			$("#Form").submit();
			$("#zhongxin").hide();
			$("#zhongxin2").show();
		}
 
		//加载已上传的图片
		var picturePaths = [];
        if($("#PICTURES").val()!=""){
            var picturePaths = $("#PICTURES").val().split(',');
            for (var i = 0; i < picturePaths.length; i++) {
                if ('' != picturePaths[i]) {
                    $('#demo1').append('<div><img src=<c:url value='/'/>'+picturePaths[i]+' class="layui-upload-img" onclick="preview(' +"'" + picturePaths[i] +"','pic'" +')" id=' + picturePaths[i] + '>'+
                        '<span class="delete layui-icon layui-icon-close" onclick="delFile(' +"'" + picturePaths[i] +"','pic'" +')"></span></div>');
                }
            }
        }
 
        //加载已上传的缩略图
        var thumbnailPaths = [];
        if($("#THUMBNAILS").val()!=""){
            var thumbnailPaths = $("#THUMBNAILS").val().split(',');
        }
 
        //加载已上传的音频
        var audioPaths = [];
        if($("#AUDIOS").val()!=""){
            var audioPaths = $("#AUDIOS").val().split(',');
            for (var i = 0; i < audioPaths.length; i++) {
                if ('' != audioPaths[i]) {
                    $('#demo2').append('<div><audio src=<c:url value='/'/>'+audioPaths[i]+' class="layui-upload-audio" id=' + audioPaths[i] + ' controls>您的浏览器不支持播放音频文件</audio>'+
                        '<span class="delete layui-icon layui-icon-close" onclick="delFile(' +"'" + audioPaths[i] +"','audio'" +')"></span></div>');
                }
            }
        }
 
        //加载已上传的视频
        var videoPaths = [];
        if($("#VIDEOS").val()!=""){
            var videoPaths = $("#VIDEOS").val().split(',');
            for (var i = 0; i < videoPaths.length; i++) {
                if ('' != videoPaths[i]) {
                    $('#demo3').append('<div><video src=<c:url value='/'/>'+videoPaths[i]+' class="layui-upload-video" id=' + videoPaths[i] + ' controls>您的浏览器不支持播放视频文件</video>'+
                        '<span class="delete layui-icon layui-icon-close" onclick="delFile(' +"'" + videoPaths[i] +"','video'" +')"></span></div>');
                }
            }
        }
 
        //加载已上传的附件
        var appendixPaths = [];
        if($("#APPENDIXS").val()!=""){
            var appendixPaths = $("#APPENDIXS").val().split(',');
            for (var i = 0; i < appendixPaths.length; i++) {
                if ('' != appendixPaths[i]) {
                    var tr = $(['<tr id="'+ appendixPaths[i] +'">'
	                  ,'<td>'+ appendixPaths[i] +'</td>'
	                  ,'<td><span style="color: #5FB878;">上传成功</span></td>'
	                  ,'<td>'
	                  ,'<span class="layui-btn layui-btn-xs layui-btn-danger" onclick="delFile(\''+appendixPaths[i]+'\',\'file'+'\');">删除文件</span>'
	                  ,'<span class="layui-btn layui-btn-xs layui-btn-normal" onclick="preview(\''+appendixPaths[i]+'\',\'file'+'\');">查看文件</span>'
                        ,'<span class="layui-btn layui-btn-xs layui-btn-warm" onclick="download(\''+appendixPaths[i]+'\');">下载文件</span>'
	                  ,'</td>'
	                  ,'</tr>'].join(''));
	                $('#demo4').append(tr);
                }
            }
        }
        
        layui.use(['form','upload'],function(){
            var form = layui.form;
            var $ = layui.jquery;
            var upload = layui.upload;
 
            //执行实例1-图片上传
            var uploadInst1 = upload.render({
                elem: '#uploadPics' //绑定元素
                ,url: "<c:url value='/upload/fileWithPath.do'/>" //上传接口
				,data: {path:'info/',tm:new Date().getTime()}
                ,accept:'images'
                ,exts:'jpg|jpeg|png|bmp|gif'
                ,multiple: true
                ,done: function(res, index, upload){
                    if("200" == res.code) {
                        if (!isBlank(res.data)){
							var paths = res.data.split(',');
							for (var i = 0; i < paths.length; i++) {
								$('#demo1').append('<div><img src=<c:url value='/'/>'+paths[i]+' class="layui-upload-img"  onclick="preview(' + "'" + paths[i] + "','pic'" + ')" id="' + paths[i] + '">' +
                                '<span class="delete layui-icon layui-icon-close" onclick="delFile(' + "'" + paths[i] + "','pic'" + ')"></span></div>');
								picturePaths.push(paths[i]);
							}
						}
                        if (!isBlank(res.thumbnail)){
							var paths = res.thumbnail.split(',');
							for (var i = 0; i < paths.length; i++) {
								thumbnailPaths.push(paths[i]);
							}
						}
                    } else {
						alert(res.msg);
					}
                    //上传完毕回调
                }
                ,error: function(index, upload){
                }
            });
 
			//执行实例2-音频上传
            var uploadInst2 = upload.render({
                elem: '#uploadAudios' //绑定元素
                ,url: "<c:url value='/upload/fileWithPath.do'/>" //上传接口
                ,data: {path:'info/',tm:new Date().getTime()}
                ,accept:'audio'
                ,exts:'wav|mp3|ogg|webm'
                ,multiple: true
                ,done: function(res, index, upload){
                    if("200" == res.code) {
                        if (!isBlank(res.data)) {
                            var paths = res.data.split(',');
							for (var i = 0; i < paths.length; i++) {
								$('#demo2').append('<div><audio src=<c:url value='/'/>' + paths[i] + ' class="layui-upload-audio" id="' + paths[i] + '" controls>您的浏览器不支持播放音频文件</audio>' +
                                '<span class="delete layui-icon layui-icon-close" onclick="delFile(' + "'" + paths[i] + "','audio'" + ')"></span></div>');
								audioPaths.push(paths[i]);
							}
							
                        }
                    } else {
						alert(res.msg);
					}
                    //上传完毕回调
                }
                ,error: function(index, upload){
                }
            });
 
            //执行实例3-视频上传
            var uploadInst3 = upload.render({
                elem: '#uploadVideos' //绑定元素
                ,url: "<c:url value='/upload/fileWithPath.do'/>" //上传接口
                ,data: {path:'info/',tm:new Date().getTime()}
                ,accept:'video'
                ,exts:'mp4|webm|ogg'
                ,multiple: true
                ,done: function(res, index, upload){
                    if("200" == res.code) {
                        if (!isBlank(res.data)) {
                            var paths = res.data.split(',');
							for (var i = 0; i < paths.length; i++) {
								$('#demo3').append('<div><video src=<c:url value='/'/>' + paths[i] + ' class="layui-upload-video" id="' + paths[i] + '" controls>您的浏览器不支持播放视频文件</video>' +
                                '<span class="delete layui-icon layui-icon-close" onclick="delFile(' + "'" + paths[i] + "','video'" + ')"></span></div>');
								videoPaths.push(paths[i]);
							}
                        }
                    } else {
						alert(res.msg);
					}
                    //上传完毕回调
                }
                ,error: function(index, upload){
                }
            });
 
            //执行实例4-文件上传
            var uploadInst4 = upload.render({
                elem: '#uploadFiles' //绑定元素
                ,url: "<c:url value='/upload/fileWithPath.do'/>" //上传接口
                ,data: {path:'info/',tm:new Date().getTime()}
                ,accept:'file'
                ,exts:'pdf'
                ,multiple: true
                ,done: function(res, index, upload){
                    if("200" == res.code) {
                        if (!isBlank(res.data)) {
							var paths = res.data.split(',');
							for (var i = 0; i < paths.length; i++) {
								var tr = $(['<tr id="' + paths[i] + '">'
									, '<td>' + paths[i] + '</td>'
									, '<td><span style="color: #5FB878;">上传成功</span></td>'
									, '<td>'
									, '<span class="layui-btn layui-btn-xs layui-btn-danger" onclick="delFile(\'' + paths[i] + '\',\'file' + '\');">删除文件</span>'
									, '<span class="layui-btn layui-btn-xs layui-btn-normal" onclick="preview(\'' + paths[i] + '\',\'file' + '\');">查看文件</span>'
									, '<span class="layui-btn layui-btn-xs layui-btn-warm" onclick="download(\'' + paths[i] + '\');">下载文件</span>'
									, '</td>'
									, '</tr>'].join(''));
								$('#demo4').append(tr);
								appendixPaths.push(paths[i]);
							}
                        }
                    } else {
						alert(res.msg);
					}
                    //上传完毕回调
                }
                ,error: function(index, upload){
                }
            });
            form.render(); //重新渲染
        });
        
        //删除文件
        function delFile(filepath, type){
            bootbox.confirm("确定要删除选中的文件吗?", function(result) {
                if(result) {
                    var pot = picturePaths.indexOf(filepath);
                    var filepath2 = thumbnailPaths[pot];
                    $.ajax({
                        type: "POST",
                        url: "<c:url value='/upload/delete.do?tm="+new Date().getTime()+"'/>",
                        data: {filePath:filepath},
                        dataType:'json',
                        cache: false,
                        success: function(data){
                            if ("200" == data.code) {
                                alert(data.msg);
                                var file = document.getElementById(filepath);
                            	if ('pic' == type) {
                                    //文件隐藏
                                    file.parentElement.style.display = "none";
                                    //删除字段
                                    picturePaths.remove(filepath);
                                } else if ('audio' == type) {
									//文件隐藏
									file.parentElement.style.display="none";
									//删除字段
									audioPaths.remove(filepath);
                                } else if ('video' == type) {
                                    //文件隐藏
                                    file.parentElement.style.display="none";
                                    //删除字段
                                    videoPaths.remove(filepath);
                                } else {
                                    //文件隐藏
                                    file.style.display="none";
	                                //删除字段
	                                appendixPaths.remove(filepath);
                                }
                            } else {
								alert(data.msg);
							}
                        }
                    });
                    //删除缩略图
                    if (!isBlank(filepath2)){
                        $.ajax({
                            type: "POST",
                            url: "<c:url value='/upload/delete.do?tm="+new Date().getTime()+"'/>",
                            data: {filePath:filepath2},
                            dataType:'json',
                            cache: false,
                            success: function(data){
                                if ("200" == data.code) {
                                    //删除字段
                                    thumbnailPaths.remove(filepath2);
                                } else {
									alert(data.msg);
								}
                            }
                        });
					}
                }
            });
        };
 
        //预览附件
        function preview(filePath, type) {
            if (isBlank(filePath)){
            } else {
                if ('pic' == type) {
                    //预览图片文件——直接打开即可
                    var url =  "<c:url value='/"+filePath+"'/>";
                    var img = "<img src='"+url+"' id='img1'/>"
                    layui.use('layer', function(){
                        var layer = layui.layer;
                        layer.open({
                            title: '查看图片详情',
                            type: 1,
                            area: ['500px', '500px'],
                            content:img
                        });
                    });
                } else if ('file' == type) {
                    //预览pdf文件——直接调用pdf.js即可，无需配置
                    var url =  "<c:url value='/"+filePath+"'/>";
                    var file =  "<c:url value='/static/pdfjs/web/viewer.html?file="+url+"'/>";
                    layui.use('layer', function(){
                        var layer = layui.layer;
                        layer.open({
                            title: '查看附件详情',
                            type: 2,
                            area: ['500px', '500px'],
                            content:file
                        });
                    });
                }
            }
        }
 
        //下载文件
        function download(filepath){
            bootbox.confirm("确定要下载此文件吗?", function(result) {
                if (result) {
                    window.location.href="<c:url value='/upload/download.do?file="+filepath+"'/>";
                }
            });
        };
		Array.prototype.indexOf = function(val) {
            for (var i = 0; i < this.length; i++) {
                if (this[i] == val) return i;
            }
            return -1;
        };
        Array.prototype.remove = function(val) {
            var index = this.indexOf(val);
            if (index > -1) {
                this.splice(index, 1);
            }
        };
		</script>
</body>
</html>